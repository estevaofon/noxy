#!/usr/bin/env python3
"""
Script para executar testes graduais do compilador Noxy
Identifica onde e como os erros acontecem para facilitar a corre√ß√£o
"""

import subprocess
import os
import sys

def run_test(test_file):
    """Executa um teste espec√≠fico e retorna o resultado"""
    print(f"\n{'='*60}")
    print(f"EXECUTANDO: {test_file}")
    print('='*60)
    
    try:
        # Tentar compilar
        compile_cmd = [
            "uv", "run", "python", "compiler.py", 
            "--compile", f"tests/{test_file}"
        ]
        
        result = subprocess.run(
            compile_cmd, 
            capture_output=True, 
            text=True, 
            cwd="."
        )
        
        if result.returncode == 0:
            print("‚úÖ COMPILA√á√ÉO: SUCESSO")
            
            # Tentar executar
            try:
                # Compilar para execut√°vel (incluindo casting_functions.c)
                gcc_cmd = ["gcc", "-mcmodel=large", "casting_functions.c", "output.obj", "-o", "test_program.exe"]
                gcc_result = subprocess.run(gcc_cmd, capture_output=True, text=True)
                
                if gcc_result.returncode == 0:
                    # Executar o programa
                    exec_result = subprocess.run(["./test_program.exe"], capture_output=True, text=True)
                    print("‚úÖ EXECU√á√ÉO: SUCESSO")
                    print("\nSA√çDA:")
                    print(exec_result.stdout)
                    return "PASS"
                else:
                    print("‚ùå ERRO NO GCC:")
                    print(gcc_result.stderr)
                    return "GCC_ERROR"
            except Exception as e:
                print(f"‚ùå ERRO NA EXECU√á√ÉO: {e}")
                return "EXEC_ERROR"
        else:
            print("‚ùå ERRO DE COMPILA√á√ÉO:")
            print(result.stdout)
            print(result.stderr)
            return "COMPILE_ERROR"
            
    except Exception as e:
        print(f"‚ùå ERRO GERAL: {e}")
        return "GENERAL_ERROR"

def main():
    """Executa todos os testes em ordem"""
    tests = [
        "test01_struct_basic.nx",
        "test02_struct_with_string.nx", 
        "test03_struct_nested.nx",
        "test04_array_simple.nx",
        "test05_array_complex.nx",
        "test06_struct_in_struct.nx",
        "test07_pair_struct.nx",
        "test08_array_of_pairs.nx",
        "test09_global_struct.nx",
        "test10_function_return_struct.nx"
    ]
    
    results = {}
    
    print("INICIANDO BATERIA DE TESTES DO COMPILADOR NOXY")
    print("Objetivo: Identificar onde e como os erros acontecem")
    
    for test in tests:
        if not os.path.exists(f"tests/{test}"):
            print(f"\n‚ùå ARQUIVO N√ÉO ENCONTRADO: {test}")
            results[test] = "NOT_FOUND"
            continue
            
        result = run_test(test)
        results[test] = result
        
        # Se o teste falhou, paramos aqui para an√°lise
        if result != "PASS":
            print(f"\nüõë TESTE FALHOU: {test}")
            print("Pare aqui para analisar o problema antes de continuar.")
            break
    
    # Resumo final
    print(f"\n{'='*60}")
    print("RESUMO DOS TESTES")
    print('='*60)
    
    for test, result in results.items():
        status_icon = "‚úÖ" if result == "PASS" else "‚ùå"
        print(f"{status_icon} {test}: {result}")
    
    # Identificar o primeiro erro
    failed_tests = [test for test, result in results.items() if result != "PASS"]
    if failed_tests:
        print(f"\nüéØ PRIMEIRO ERRO: {failed_tests[0]}")
        print("Este √© o teste que precisa ser corrigido primeiro no compilador.")
    else:
        print("\nüéâ TODOS OS TESTES PASSARAM!")

if __name__ == "__main__":
    main()
